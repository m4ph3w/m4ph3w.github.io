<!DOCTYPE html>
<html lang="zh-Hans">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>大六壬・射覆 | Oracle Lab</title>
  <meta name="description" content="一个好玩的静态网站：大六壬速占、射覆小游戏、术数词汇与学习笔记。纯前端，可直接部署到 GitHub Pages。" />
  <meta property="og:title" content="大六壬・射覆 | Oracle Lab" />
  <meta property="og:description" content="大六壬速占、射覆小游戏、术数词汇与学习笔记。纯前端，可直接部署到 GitHub Pages。" />
  <meta property="og:type" content="website" />
  <meta property="og:image" content="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='630'%3E%3Crect width='100%25' height='100%25' fill='%23111113'/%3E%3Ctext x='50%25' y='50%25' dominant-baseline='middle' text-anchor='middle' font-family='serif' font-size='64' fill='%23E6D8B9'%3E大六壬・射覆%3C/text%3E%3C/svg%3E" />
  <link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 64 64'%3E%3Crect x='2' y='2' width='60' height='60' rx='12' fill='%230c0c0e'/%3E%3Ccircle cx='32' cy='32' r='20' fill='%23c8b68f'/%3E%3Ccircle cx='32' cy='32' r='10' fill='%230c0c0e'/%3E%3C/svg%3E" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@400;600;700&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0b0b0d;
      --bg-soft: #121217;
      --panel: #15151b;
      --ink: #eae6df;
      --ink-dim: #cfc7ba;
      --brand: #d4b46a;
      --brand-2: #8fb3d9;
      --accent: #65c3a6;
      --muted: #7a756b;
      --ring: rgba(212,180,106,0.35);
      --ok: #6bd08c;
      --warn: #f0b35a;
      --bad: #ff6b6b;
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
    }
    * { box-sizing: border-box; }
    html, body { margin:0; padding:0; background: var(--bg); color: var(--ink); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, 'Noto Sans', 'Helvetica Neue', Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; }
    h1,h2,h3 { font-family: 'Noto Serif SC', serif; letter-spacing: .3px; }
    a { color: var(--brand-2); text-decoration: none; }
    a:hover { text-decoration: underline; }
    .wrap { max-width: 1200px; margin: 0 auto; padding: 24px; }
    header.nav {
      position: sticky; top:0; z-index: 50; backdrop-filter: saturate(180%) blur(10px);
      background: linear-gradient(180deg, rgba(11,11,13,0.95), rgba(11,11,13,0.65)); border-bottom: 1px solid #1f1f27;
    }
    .nav-inner{ display:flex; align-items:center; justify-content:space-between; gap:12px; padding:14px 24px; }
    .brand { display:flex; align-items:center; gap:12px; font-weight:700; }
    .brand .logo { width:28px; height:28px; display:grid; place-items:center; border-radius:10px; background: radial-gradient(100% 100% at 30% 20%, #2a2a34 0%, #121217 60%);
      box-shadow: inset 0 0 0 1px #2b2b35;
    }
    .brand .logo svg{ width:18px; height:18px; }
    .brand span{ font-family: 'Noto Serif SC', serif; color: var(--ink); }
    .nav-links { display:flex; gap:16px; font-weight:500; }
    .nav-links a { display:inline-block; padding:8px 12px; border-radius:10px; }
    .nav-links a:hover { background: #1a1a22; }
    .ctrls { display:flex; gap:8px; }
    .btn { border:1px solid #2a2a32; background: #14141a; color: var(--ink); padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; }
    .btn:hover { background:#1a1a22; }
    .btn.primary { background: linear-gradient(180deg, #2a2415, #18140a); border-color:#3a3424; color: #f1e8d6; }
    .btn.primary:hover { filter: brightness(1.05); }
    
    .hero { padding: 56px 24px; display:grid; grid-template-columns: 1.2fr 1fr; gap: 24px; align-items:center; }
    @media (max-width: 900px){ .hero{ grid-template-columns:1fr; padding-top:28px; } }
    .hero-card { background: radial-gradient(120% 120% at 20% 10%, #18181f 0%, #0c0c0f 60%); border:1px solid #2a2a34; border-radius: var(--radius); padding: 28px; box-shadow: var(--shadow); }
    .hero h1 { font-size: clamp(28px, 4vw, 44px); margin:0 0 10px; line-height:1.15; color:#f3ead7; }
    .hero p { color: var(--ink-dim); font-size: 15px; line-height:1.6; }
    .tag { display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border:1px dashed #3a3323; border-radius:999px; background:#131217; color:#e6d8b9; font-weight:600; margin-bottom:14px; }
    .scroll-hint { font-size: 12px; color:#9a927f; margin-top:10px; }
    
    .grid { display:grid; grid-template-columns: repeat(12, 1fr); gap: 18px; }
    .card { grid-column: span 12; background: linear-gradient(180deg, #14141a, #0f0f14); border:1px solid #2a2a34; border-radius: var(--radius); padding: 22px; box-shadow: var(--shadow); }
    .card h2 { margin-top:0; font-size: 22px; color:#f0e6cf; }
    .kicker { color: var(--muted); font-size: 13px; font-weight:700; letter-spacing:.2em; text-transform: uppercase; margin-bottom: 6px; }
    .muted { color: var(--muted); }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; border:1px solid #2b2b35; font-size: 12px; }
    .hr { height:1px; background:#262631; margin: 16px 0; }

    /* Feature specific */
    .columns { display:grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
    @media (max-width: 900px){ .columns{ grid-template-columns: 1fr; } }
    .feature { background:#121219; border:1px solid #242433; border-radius: 14px; padding:16px; }

    /* Shefu Game */
    .game { display:grid; grid-template-columns: 1.2fr 0.8fr; gap: 16px; }
    @media (max-width: 900px){ .game{ grid-template-columns: 1fr; } }
    .reveal-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .hint { background:#13131a; border:1px dashed #2f2f3a; border-radius:12px; padding:12px; font-size: 14px; color:#d6d0c5; }
    .guess-area { display:flex; gap:8px; margin-top:10px; }
    .select, .input, .textarea { width:100%; background:#111118; border:1px solid #2a2a34; border-radius:10px; padding:10px 12px; color:var(--ink); }
    .badge { font-size: 12px; padding: 4px 8px; border-radius: 999px; border:1px solid #2a2a34; }
    .result { padding:12px; border-radius:12px; border:1px solid #30303a; background:#101019; }
    .result.ok { border-color:#285b3d; background:#0f1613; }
    .result.bad { border-color:#5b2d2d; background:#161010; }

    /* Liu Ren */
    .pan { display:grid; grid-template-columns: repeat(6, 1fr); gap:8px; margin-top:8px; }
    .branch { background:#12121a; border:1px solid #2a2a34; border-radius:10px; padding:10px; text-align:center; font-family:'Noto Serif SC', serif; }
    .branch.highlight { outline: 2px solid var(--brand); background: #191812; }
    .legend { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px; }

    /* Notebook */
    .note-row { display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center; }
    .note-row p { margin:0; font-size:14px; color:#ddd7cc; }
    .soft { color:#9a927f; font-size:12px; }

    /* Liu Yao (六爻) */
    .yi { display:grid; grid-template-columns: 1.1fr 1fr; gap: 16px; }
    @media (max-width: 900px){ .yi{ grid-template-columns: 1fr; } }
    .line-inputs { display:grid; grid-template-rows: repeat(6, auto); gap: 8px; }
    .line-row { display:flex; align-items:center; justify-content:space-between; gap: 10px; }
    .line-row label { width: 110px; color: var(--ink-dim); }
    .line-select { background:#111118; border:1px solid #2a2a34; border-radius:10px; padding:8px 10px; color:var(--ink); }
    .order { display:flex; gap:10px; align-items:center; margin: 8px 0 4px; color: var(--muted); }

    .hexbox { background:#121219; border:1px solid #242433; border-radius:14px; padding:12px; }
    .hex-title { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
    .hex { display:flex; flex-direction:column; gap:8px; padding:10px 0; }
    .gline { height:10px; border-radius:6px; position:relative; background:linear-gradient(180deg, #2a2a34, #1a1a22); }
    .gline.yin { background: none; }
    .gline.yin::before, .gline.yin::after { content:""; display:block; position:absolute; top:0; bottom:0; width:42%; background:linear-gradient(180deg,#2a2a34,#1a1a22); border-radius:6px; }
    .gline.yin::before { left:0; }
    .gline.yin::after { right:0; }
    .gline.moving { outline:2px solid var(--brand); box-shadow:0 0 0 3px rgba(212,180,106,0.15); }

    .tiny { font-size:12px; color:var(--muted); }

    footer { margin: 40px 0 24px; color:#9a927f; text-align:center; }
    .foot-links { display:flex; gap:14px; justify-content:center; }

    .ring:focus { outline: none; box-shadow: 0 0 0 6px var(--ring); }
  </style>
</head>
<body>
  <header class="nav">
    <div class="nav-inner wrap" style="padding-left:0;padding-right:0;">
      <div class="brand">
        <div class="logo" aria-hidden="true">
          <svg viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="8" stroke="#c8b68f" stroke-width="2"/>
            <circle cx="12" cy="12" r="4" fill="#c8b68f"/>
          </svg>
        </div>
        <span>大六壬・射覆</span>
      </div>
      <nav class="nav-links">
        <a href="#play">射覆</a>
        <a href="#liuren">大六壬</a>
        <a href="#liuyao">六爻</a>
        <a href="#gloss">术语</a>
        <a href="#notebook">笔记</a>
      </nav>
      <div class="ctrls">
        <button class="btn" id="toggleTheme" aria-label="切换主题">☯︎</button>
        <a class="btn primary" href="#deploy">部署到 GitHub Pages</a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="hero-card">
        <div class="tag">純前端 · GitHub Pages 即可部署 · 零后端</div>
        <h1>Oracle Lab：<br/>大六壬速占 × 射覆小游戏</h1>
        <p>
          这是一个 <strong>完全前端</strong> 的小站：左手 <em>大六壬</em>，右手 <em>射覆</em>。你可以随手来一卦、玩一把"覆杯猜物"，把结果记进笔记本。
          所有数据仅存于你的浏览器 <code>localStorage</code>，隐私友好。
        </p>
        <p class="scroll-hint">↓ 向下滚动开始占玩</p>
      </div>
      <div class="hero-card">
        <div class="columns">
          <div class="feature">
            <div class="kicker">Quick Cast</div>
            <h3 style="margin:.2rem 0 .6rem">三传一览</h3>
            <p class="muted">简化版大六壬：随机三传与日干五行，给出"生克"评价与一段占辞，适合入门/演示。</p>
          </div>
          <div class="feature">
            <div class="kicker">Game</div>
            <h3 style="margin:.2rem 0 .6rem">射覆·覆杯猜物</h3>
            <p class="muted">选择提示（声/重/材/形）后作答。命中则"中！"；未中亦有趣味占辞点缀。</p>
          </div>
          <div class="feature">
            <div class="kicker">Notebook</div>
            <h3 style="margin:.2rem 0 .6rem">私有笔记</h3>
            <p class="muted">把每次试占记录在案，可导出 JSON，切换设备也能导入复现。</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Shefu Game -->
    <section id="play" class="card">
      <div class="kicker">Game</div>
      <h2>射覆：覆杯猜物 · Mini</h2>
      <p class="muted">玩法：系统暗置一物。你可先开启最多 <strong>三個提示</strong>（聲 / 重 / 材 / 形），再从下拉中猜测。命中即胜；未中亦给占辞启示。</p>
      <div class="hr"></div>
      <div class="game">
        <div>
          <div class="reveal-grid" id="hintGrid"></div>
          <div class="guess-area">
            <select id="guessSelect" class="select ring" aria-label="选择你猜的物件"></select>
            <button class="btn" id="revealOne">开一条提示</button>
            <button class="btn primary" id="submitGuess">提交猜测</button>
          </div>
          <div id="shefuResult" style="margin-top:12px"></div>
        </div>
        <aside>
          <div class="hint">
            <strong>小注</strong>
            <p class="muted" style="margin:.4rem 0 0">古人射覆，也重"问难设疑"。凡物多可从「材、形、声、重、气味、用」几端推求。此处取其四，略具一斑。</p>
            <div style="margin-top:8px" class="legend">
              <span class="pill">聲：清脆/沉闷/沙沙</span>
              <span class="pill">重：轻/中/重</span>
              <span class="pill">材：金/木/石(玉)/陶/纸</span>
              <span class="pill">形：圆/方/长/不规则</span>
            </div>
          </div>
        </aside>
      </div>
    </section>

    <!-- Liu Ren -->
    <section id="liuren" class="card">
      <div class="kicker">Liu Ren</div>
      <h2>大六壬・速占演示</h2>
      <div class="hint">
        <strong>简明说明（白话）</strong>
        <ul class="muted" style="margin:.4rem 0 0; padding-left:18px">
          <li>传统六壬需按日辰、四课三传、天盘地盘等推演；本演示版做了<strong>极简</strong>：随机给出"日干五行"和"三传"三个地支，只做<strong>生克倾向</strong>提示。</li>
          <li><em>怎么读：</em>看"日干"的五行，与三传各自五行之间是相生还是相克。生多于克⇒顺势而为；克多于生⇒先谋后动；相当⇒人事主导。</li>
          <li>这只是把<strong>关系</strong>算出来，并非完整断语。真正占断要看贵神、旺相休囚、用神等，本工具未纳入。</li>
          <li>想留档？点「存入笔记」。数据只保存在你的浏览器。</li>
        </ul>
      </div>
      <div>
        <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
          <button class="btn primary" id="cast">起一课</button>
          <button class="btn" id="saveCast">存入笔记</button>
          <span class="soft" id="castSummary"></span>
        </div>
        <div class="pan" id="pan"></div>
        <div class="legend" id="legend"></div>
        <div id="castResult" style="margin-top:10px"></div>
      </div>
    </section>

    <!-- Liu Yao -->
    <section id="liuyao" class="card">
      <div class="kicker">Liu Yao</div>
      <h2>六爻・卦象计算</h2>
      <div class="hint">
        <strong>简明说明（白话）</strong>
        <ul class="muted" style="margin:.4rem 0 0; padding-left:18px">
          <li>你<strong>已起卦</strong>（硬币/蓍草/其它），得到 6 个数字（6/7/8/9）。本工具不帮你起卦，只把这<strong>6 个数换算</strong>成：本卦、之卦、互卦。</li>
          <li>本卦：把数字变成阴阳线（7/9=阳，6/8=阴），自下而上排成六爻卦。</li>
          <li>动爻：6、9 为动，会在「之卦」里<strong>反转阴阳</strong>；没有动爻时，本卦=之卦。</li>
          <li>互卦：取原卦第 2–4 爻为下卦，第 3–5 爻为上卦，常用于看<strong>内部发展</strong>。</li>
          <li>卦名/序号仅作识别；具体断事需另行用神、六亲、世应等规则（本工具暂未加入）。</li>
          <li>完成后可「保存到笔记」，方便回顾（仅存本机）。</li>
        </ul>
      </div>
      <div class="yi">
        <div>
          <div class="order">
            <span class="pill">输入顺序</span>
            <label><input type="radio" name="lyOrder" value="topdown" checked> 上→下</label>
            <label><input type="radio" name="lyOrder" value="bottomup"> 下→上</label>
          </div>
          <div class="line-inputs" id="lyInputs"></div>
          <div style="display:flex; gap:10px; flex-wrap:wrap; margin-top:10px">
            <button class="btn primary" id="computeLiuyao">计算</button>
            <button class="btn" id="saveLiuyao">保存到笔记</button>
            <span class="soft" id="lySummary"></span>
          </div>
        </div>
        <aside>
          <div class="hexbox" style="margin-bottom:10px">
            <div class="hex-title"><strong>本卦</strong><span class="tiny" id="lyBaseInfo"></span></div>
            <div id="lyBaseHex" class="hex"></div>
          </div>
          <div class="hexbox" style="margin-bottom:10px">
            <div class="hex-title"><strong>之卦</strong><span class="tiny" id="lyChangedInfo"></span></div>
            <div id="lyChangedHex" class="hex"></div>
          </div>
          <div class="hexbox">
            <div class="hex-title"><strong>互卦</strong><span class="tiny" id="lyMutualInfo"></span></div>
            <div id="lyMutualHex" class="hex"></div>
          </div>
        </aside>
      </div>
      <div class="hint" style="margin-top:12px">
        <strong>说明</strong>
        <ul class="muted" style="margin:.4rem 0 0; padding-left:18px">
          <li>本卦：以阴阳定形，不考虑动变。</li>
          <li>之卦：动爻变阴阳而成；若无动爻，则与本卦相同。</li>
          <li>互卦：取原卦第 2–4 爻为下卦，第 3–5 爻为上卦（六爻互卦惯用定义）。</li>
        </ul>
      </div>
    </section>

    <!-- Glossary -->
    <section id="gloss" class="card">
      <div class="kicker">术语 / Glossary</div>
      <h2>入门词汇（简述）</h2>
      <div class="columns">
        <div class="feature">
          <h3>大六壬</h3>
          <p class="muted">三式之一（太乙、遁甲、六壬）。以天干地支、四课三传等排布推断休咎。此站仅提供趣味化、教育向演示。</p>
        </div>
        <div class="feature">
          <h3>四课三传</h3>
          <p class="muted">传统以日干支、天盘地盘等次第立四课、取三传。此处<strong>不作严密推演</strong>，仅示"三传"概念与生克关系。</p>
        </div>
        <div class="feature">
          <h3>射覆</h3>
          <p class="muted">古代文人雅戏：覆器藏物，设辞以射。可作为推理、观察与设问的训练。</p>
        </div>
      </div>
    </section>

    <!-- Notebook -->
    <section id="notebook" class="card">
      <div class="kicker">Notebook</div>
      <h2>占玩笔记（仅本机）</h2>
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <button class="btn" id="exportNotes">导出 JSON</button>
        <label class="btn" for="importFile" style="cursor:pointer">导入 JSON<input id="importFile" type="file" accept="application/json" style="display:none"/></label>
        <button class="btn" id="clearNotes">清空</button>
      </div>
      <div class="hr"></div>
      <div id="notes"></div>
    </section>

    <!-- Deploy instructions -->
    <section id="deploy" class="card">
      <div class="kicker">Deploy</div>
      <h2>一键上线到 GitHub Pages</h2>
      <ol>
        <li>在 GitHub 新建仓库，命名为：<code>你的用户名.github.io</code>（比如 <code>kaihochu.github.io</code>）。</li>
        <li>把本页文件保存为 <code>index.html</code> 上传到仓库根目录。</li>
        <li>进入仓库 Settings → Pages，确认 <em>Source: Deploy from a branch</em> 且分支为 <code>main</code>（或 <code>master</code>）。</li>
        <li>几分钟后，用浏览器访问：<code>https://你的用户名.github.io</code> 就能看到网站上线啦。</li>
      </ol>
      <p class="muted">想要自定义文案与标题？编辑顶部 <code>&lt;title&gt;</code> 与文案段落即可。需要更多页面，可以新增文件并在导航添加链接。</p>
    </section>

    <footer>
      <div>© <span id="year"></span> Oracle Lab · 大六壬 × 射覆 · 静态站点</div>
      <div class="foot-links"><a href="#">返回顶部</a><span>·</span><a href="#gloss">术语</a><span>·</span><a href="#deploy">部署</a></div>
    </footer>
  </main>

  <script>
    // ---------- Utilities ----------
    const $ = (sel) => document.querySelector(sel);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const rnd = (arr) => arr[Math.floor(Math.random() * arr.length)];

    const five = { 木:'木', 火:'火', 土:'土', 金:'金', 水:'水' };
    const sheng = { 水:'木', 木:'火', 火:'土', 土:'金', 金:'水' }; // 相生：key 生 value
    const ke    = { 水:'火', 火:'金', 金:'木', 木:'土', 土:'水' }; // 相克：key 克 value

    const stems = [
      {k:'甲', w: '木'}, {k:'乙', w:'木'}, {k:'丙', w:'火'}, {k:'丁', w:'火'},
      {k:'戊', w:'土'}, {k:'己', w:'土'}, {k:'庚', w:'金'}, {k:'辛', w:'金'}, {k:'壬', w:'水'}, {k:'癸', w:'水'}
    ];

    const branches = [
      {z:'子', w:'水'}, {z:'丑', w:'土'}, {z:'寅', w:'木'}, {z:'卯', w:'木'},
      {z:'辰', w:'土'}, {z:'巳', w:'火'}, {z:'午', w:'火'}, {z:'未', w:'土'},
      {z:'申', w:'金'}, {z:'酉', w:'金'}, {z:'戌', w:'土'}, {z:'亥', w:'水'}
    ];

    const poems = [
      '雲開見月，事有轉圜之機。',
      '風起於青萍之末，細微處可逆推全局。',
      '水到渠成，且待時至。',
      '金木相刑，慎爭鋒而求和。',
      '火土相生，勞苦後見實成。',
      '勢有足輕重，衡之而後動。',
      '陰陽更替，守正以出奇。',
      '此去有波折，亦不失可行之道。'
    ];

    // ---------- Shefu (覆杯猜物) ----------
    const OBJECTS = [
      {id:'coin',    name:'銅錢',    material:'金', shape:'圓',  sound:'清脆', weight:'輕'},
      {id:'key',     name:'鐵鑰匙',  material:'金', shape:'不規則', sound:'清脆', weight:'中'},
      {id:'jade',    name:'玉佩',    material:'石', shape:'橢圓', sound:'清脆', weight:'中'},
      {id:'stick',   name:'木簽',    material:'木', shape:'長',  sound:'沉悶', weight:'輕'},
      {id:'paper',   name:'紙團',    material:'紙', shape:'圓',  sound:'沙沙', weight:'輕'},
      {id:'pottery', name:'陶片',    material:'陶', shape:'不規則', sound:'沉悶', weight:'中'},
      {id:'dice',    name:'骰子',    material:'石', shape:'方',  sound:'清脆', weight:'輕'}
    ];
    const HINT_KEYS = [
      {key:'sound', label:'聲'},
      {key:'weight', label:'重'},
      {key:'material', label:'材'},
      {key:'shape', label:'形'}
    ];

    let secret = null;
    let revealed = new Set();

    function newShefuRound(){
      secret = rnd(OBJECTS);
      revealed.clear();
      renderHints();
      renderGuessOptions();
      $('#shefuResult').innerHTML = '';
    }

    function renderHints(){
      const grid = $('#hintGrid');
      grid.innerHTML = '';
      HINT_KEYS.forEach(h => {
        const isOpen = revealed.has(h.key);
        const div = document.createElement('div');
        div.className = 'hint';
        div.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center"><strong>${h.label}</strong><span class="badge">${isOpen ? '已開' : '未開'}</span></div>` +
          (isOpen ? `<div class="hr"></div><div>${formatHint(h.key, secret[h.key])}</div>` : `<div class="hr"></div><div class="soft">點擊「開一條提示」隨機揭示</div>`);
        grid.appendChild(div);
      });
    }
    function formatHint(key, val){
      const map = {
        sound: {清脆:'清脆（叮當）', 沉悶:'沉悶（咚）', 沙沙:'沙沙（簌簌）'},
        weight: {輕:'輕', 中:'中等', 重:'較重'},
        material: {金:'金屬', 木:'木質', 石:'石/玉', 陶:'陶/瓷', 紙:'紙'},
        shape: {圓:'圓', 方:'方', 長:'細長', 橢圓:'橢圓', 不規則:'不規則'}
      };
      return map[key] && map[key][val] ? map[key][val] : val;
    }

    function renderGuessOptions(){
      const sel = $('#guessSelect');
      sel.innerHTML = OBJECTS.map(o => `<option value="${o.id}">${o.name}</option>`).join('');
    }

    function revealOne(){
      const candidates = HINT_KEYS.map(h=>h.key).filter(k=>!revealed.has(k));
      if(candidates.length === 0){
        toast('提示已全部開啟');
        return;
      }
      const key = rnd(candidates);
      revealed.add(key);
      renderHints();
    }

    function submitGuess(){
      const id = $('#guessSelect').value;
      const correct = id === secret.id;
      const box = document.createElement('div');
      box.className = 'result ' + (correct ? 'ok' : 'bad');
      const poem = rnd(poems);
      box.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center;gap:8px"><div><strong>${correct ? '中！' : '未中'}</strong> 覆下之物為：<em>${secret.name}</em></div>
      <span class="pill">占辭：${poem}</span></div>`;
      $('#shefuResult').innerHTML = '';
      $('#shefuResult').appendChild(box);
      // write to notes
      addNote({
        type:'shefu',
        correct,
        target: secret.name,
        hints: Array.from(revealed).map(k => ({label: HINT_KEYS.find(h=>h.key===k).label, value: formatHint(k, secret[k])})),
        poem,
        ts: Date.now()
      });
      // start next round automatically after a short pause
      setTimeout(()=>{ newShefuRound(); }, 800);
    }

    $('#revealOne').addEventListener('click', revealOne);
    $('#submitGuess').addEventListener('click', submitGuess);

    // ---------- Liu Ren (simplified) ----------
    function castLiuRen(){
      // Random day stem (as a proxy for日干)
      const day = rnd(stems);
      // Random three transmissions
      const three = [rnd(branches), rnd(branches), rnd(branches)];
      // Evaluate generating/controlling counts wrt day element
      let gen=0, ctrl=0;
      three.forEach(b => {
        if (sheng[day.w] === b.w) gen++;
        if (ke[day.w] === b.w) ctrl++;
      });
      let tone = '';
      if(gen>ctrl) tone = '相生有餘，利順勢而為。';
      else if(ctrl>gen) tone = '相克見多，宜謀後動。';
      else tone = '生克相半，進退皆可，重取決於人。';

      const poem = rnd(poems);
      const out = {
        day,
        three,
        tone,
        poem
      };
      renderCast(out);
      return out;
    }

    function renderCast(c){
      // Pan render
      const pan = $('#pan');
      pan.innerHTML = '';
      branches.forEach(b => {
        const div = document.createElement('div');
        div.className = 'branch';
        const idx = c.three.findIndex(tb => tb.z === b.z);
        if(idx>-1) div.classList.add('highlight');
        div.innerHTML = `<div style="font-size:22px">${b.z}</div><div class="soft">五行:${b.w}</div>` + (idx>-1?`<div class="pill" style="margin-top:6px">傳${idx+1}</div>`:'');
        pan.appendChild(div);
      });
      // Legend
      $('#legend').innerHTML = `
        <span class="pill">日干：<strong>${c.day.k}</strong>（${c.day.w}）</span>
        <span class="pill">相生：${Object.entries(sheng).map(([a,b])=>`${a}生${b}`).join('，')}</span>
        <span class="pill">相克：${Object.entries(ke).map(([a,b])=>`${a}克${b}`).join('，')}</span>
      `;
      // Summary
      $('#castSummary').textContent = `日干 ${c.day.k} · 三傳：${c.three.map(t=>t.z).join(' → ')}`;
      // Result
      $('#castResult').innerHTML = `
        <div class="result" style="margin-top:8px">
          <div style="display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap">
            <div><strong>占評：</strong>${c.tone}</div>
            <span class="pill">占辭：${c.poem}</span>
          </div>
        </div>
      `;
    }

    let lastCast = null;
    $('#cast').addEventListener('click', ()=>{ lastCast = castLiuRen(); });
    $('#saveCast').addEventListener('click', ()=>{
      if(!lastCast){ toast('請先起一課'); return; }
      addNote({
        type:'liuren',
        day: lastCast.day.k + '('+ lastCast.day.w +')',
        three: lastCast.three.map(t=>t.z + '('+t.w+')'),
        tone: lastCast.tone,
        poem: lastCast.poem,
        ts: Date.now()
      });
      toast('已存入筆記');
    });

    // ---------- Notebook ----------
    const LS_KEY = 'oracle-notes-v1';
    function loadNotes(){
      try { return JSON.parse(localStorage.getItem(LS_KEY) || '[]'); } catch(e){ return []; }
    }
    function saveNotes(arr){ localStorage.setItem(LS_KEY, JSON.stringify(arr)); renderNotes(); }
    function addNote(n){ const arr = loadNotes(); arr.unshift(n); saveNotes(arr); }

    function renderNotes(){
      const wrap = $('#notes');
      const arr = loadNotes();
      if(arr.length===0){ wrap.innerHTML = '<p class="soft">暂无记录。</p>'; return; }
      wrap.innerHTML = '';
      arr.forEach((n, i) => {
        const card = document.createElement('div');
        card.className = 'feature';
        const time = new Date(n.ts).toLocaleString();
        let body = '';
        if(n.type==='shefu'){
          body = `
            <div class="note-row"><p>【射覆】${n.correct?'<span style="color:var(--ok)">命中</span>':'<span style="color:var(--bad)">未中</span>'}，覆下之物：<strong>${n.target}</strong></p>
            <button class="btn" data-del="${i}">删除</button></div>
            <p class="soft">提示：${n.hints.map(h=>h.label+': '+h.value).join('， ')} · ${time}</p>
            <p class="muted">占辭：${n.poem}</p>
          `;
        } else if(n.type==='liuren'){
          body = `
            <div class="note-row"><p>【六壬】日干：<strong>${n.day}</strong> · 三傳：<strong>${n.three.join(' → ')}</strong></p>
            <button class="btn" data-del="${i}">删除</button></div>
            <p class="muted">占評：${n.tone}</p>
            <p class="soft">占辭：${n.poem} · ${time}</p>
          `;
        } else if(n.type==='liuyao'){
          body = `
            <div class="note-row"><p>【六爻】本卦：<strong>${n.base}</strong> · 之卦：<strong>${n.changed}</strong> · 互卦：<strong>${n.mutual}</strong></p>
            <button class="btn" data-del="${i}">删除</button></div>
            <p class="soft">动爻：${(n.moving&&n.moving.length)? n.moving.join(', ') : '无'} · ${time}</p>
          `;
        }
        card.innerHTML = body;
        wrap.appendChild(card);
      });
      // hook delete
      $$('#notes .btn[data-del]').forEach(btn => btn.addEventListener('click', (e)=>{
        const idx = Number(e.currentTarget.getAttribute('data-del'));
        const arr = loadNotes();
        arr.splice(idx,1);
        saveNotes(arr);
      }));
    }

    $('#exportNotes').addEventListener('click', ()=>{
      const data = localStorage.getItem(LS_KEY) || '[]';
      const blob = new Blob([data], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'oracle-notes.json'; a.click();
      setTimeout(()=>URL.revokeObjectURL(url), 500);
    });
    $('#importFile').addEventListener('change', (e)=>{
      const file = e.target.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = () => { try{ localStorage.setItem(LS_KEY, reader.result); toast('导入完成'); renderNotes(); } catch(err){ toast('导入失败'); } };
      reader.readAsText(file);
      e.target.value = '';
    });
    $('#clearNotes').addEventListener('click', ()=>{
      if(confirm('确定清空全部笔记？')){ localStorage.removeItem(LS_KEY); renderNotes(); }
    });

    // ---------- Liu Yao (六爻) ----------
    const TRIGRAM_NAMES = ['坤','艮','坎','巽','震','离','兑','乾']; // index by (b0 + b1*2 + b2*4) bottom->top bits
    const TRIGRAM_CN = { '乾':'天','兑':'泽','离':'火','震':'雷','巽':'风','坎':'水','艮':'山','坤':'地' };
    const HEX_MAP = {
      '乾|乾': {num:1, name:'乾为天'},  '坤|坤': {num:2, name:'坤为地'},
      '坎|震': {num:3, name:'水雷屯'},  '艮|坎': {num:4, name:'山水蒙'},
      '坎|乾': {num:5, name:'水天需'},  '乾|坎': {num:6, name:'天水讼'},
      '坤|坎': {num:7, name:'地水师'},  '坎|坤': {num:8, name:'水地比'},
      '巽|乾': {num:9, name:'风天小畜'}, '乾|兑': {num:10, name:'天泽履'},
      '坤|乾': {num:11, name:'地天泰'},   '乾|坤': {num:12, name:'天地否'},
      '乾|离': {num:13, name:'天火同人'}, '离|乾': {num:14, name:'火天大有'},
      '坤|艮': {num:15, name:'地山谦'},   '震|坤': {num:16, name:'雷地豫'},
      '兑|震': {num:17, name:'泽雷随'},   '艮|巽': {num:18, name:'山风蛊'},
      '坤|兑': {num:19, name:'地泽临'},   '巽|坤': {num:20, name:'风地观'},
      '离|震': {num:21, name:'火雷噬嗑'}, '艮|离': {num:22, name:'山火贲'},
      '艮|坤': {num:23, name:'山地剥'},   '坤|震': {num:24, name:'地雷复'},
      '乾|震': {num:25, name:'天雷无妄'}, '艮|乾': {num:26, name:'山天大畜'},
      '艮|震': {num:27, name:'山雷颐'},   '兑|巽': {num:28, name:'泽风大过'},
      '坎|坎': {num:29, name:'坎为水'},   '离|离': {num:30, name:'离为火'},
      '兑|艮': {num:31, name:'泽山咸'},   '震|巽': {num:32, name:'雷风恒'},
      '乾|艮': {num:33, name:'天山遯'},   '震|乾': {num:34, name:'雷天大壮'},
      '离|坤': {num:35, name:'火地晋'},   '坤|离': {num:36, name:'地火明夷'},
      '巽|离': {num:37, name:'风火家人'}, '离|兑': {num:38, name:'火泽睽'},
      '坎|艮': {num:39, name:'水山蹇'},   '震|坎': {num:40, name:'雷水解'},
      '艮|兑': {num:41, name:'山泽损'},   '巽|震': {num:42, name:'风雷益'},
      '兑|乾': {num:43, name:'泽天夬'},   '乾|巽': {num:44, name:'天风姤'},
      '兑|坤': {num:45, name:'泽地萃'},   '坤|巽': {num:46, name:'地风升'},
      '兑|坎': {num:47, name:'泽水困'},   '坎|巽': {num:48, name:'水风井'},
      '兑|离': {num:49, name:'泽火革'},   '离|巽': {num:50, name:'火风鼎'},
      '震|震': {num:51, name:'震为雷'},   '艮|艮': {num:52, name:'艮为山'},
      '巽|艮': {num:53, name:'风山渐'},   '震|兑': {num:54, name:'雷泽归妹'},
      '震|离': {num:55, name:'雷火丰'},   '离|艮': {num:56, name:'火山旅'},
      '巽|巽': {num:57, name:'巽为风'},   '兑|兑': {num:58, name:'兑为泽'},
      '巽|坎': {num:59, name:'风水涣'},   '坎|兑': {num:60, name:'水泽节'},
      '巽|兑': {num:61, name:'风泽中孚'}, '震|艮': {num:62, name:'雷山小过'},
      '坎|离': {num:63, name:'水火既济'}, '离|坎': {num:64, name:'火水未济'}
    };

    function valToYinYang(v){ // true=阳, false=阴
      return v===7 || v===9; // 7/9 阳；6/8 阴
    }
    function valIsMoving(v){ return v===6 || v===9; }

    function trigramNameFromBits(b0,b1,b2){ // bottom->top bits
      const idx = (b0?1:0) + (b1?2:0) + (b2?4:0);
      return TRIGRAM_NAMES[idx];
    }

    function hexInfoFromLines(linesBool){ // lines bottom->top [6]
      const lower = linesBool.slice(0,3); const upper = linesBool.slice(3,6);
      const tLower = trigramNameFromBits(lower[0],lower[1],lower[2]);
      const tUpper = trigramNameFromBits(upper[0],upper[1],upper[2]);
      const key = `${tUpper}|${tLower}`;
      const meta = HEX_MAP[key] || {num:'-', name:`${TRIGRAM_CN[tUpper]||tUpper}${TRIGRAM_CN[tLower]||tLower}`};
      return { upper:tUpper, lower:tLower, num: meta.num, name: meta.name };
    }

    function renderHexagram(container, linesBool, movingFlags){ // bottom->top arrays
      container.innerHTML = '';
      for(let i=5;i>=0;i--){
        const div = document.createElement('div');
        const yin = !linesBool[i];
        div.className = 'gline '+(yin?'yin':'yang') + (movingFlags && movingFlags[i] ? ' moving' : '');
        container.appendChild(div);
      }
    }

    function computeLiuYao(){
      // gather inputs top→down or bottom→up per radio
      const order = document.querySelector('input[name="lyOrder"]:checked').value; // 'topdown' | 'bottomup'
      const valsTopDown = Array.from(document.querySelectorAll('.ly-line-select')).map(sel=>Number(sel.value));
      let valsBottomUp;
      if(order==='topdown') valsBottomUp = valsTopDown.slice().reverse(); else valsBottomUp = valsTopDown.slice();
      // convert to yin/yang & moving flags (bottom->top)
      const bools = valsBottomUp.map(valToYinYang);
      const moving = valsBottomUp.map(valIsMoving);
      // base hex
      const baseInfo = hexInfoFromLines(bools);
      renderHexagram(document.getElementById('lyBaseHex'), bools, moving);
      document.getElementById('lyBaseInfo').textContent = `[#${baseInfo.num}] ${baseInfo.name} · 上${TRIGRAM_CN[baseInfo.upper]} 下${TRIGRAM_CN[baseInfo.lower]}`;
      // changed hex
      const changedBools = bools.map((b, i)=> moving[i] ? !b : b);
      const changedInfo = hexInfoFromLines(changedBools);
      renderHexagram(document.getElementById('lyChangedHex'), changedBools, moving.some(m=>m)?moving:undefined);
      document.getElementById('lyChangedInfo').textContent = (moving.some(m=>m) ? `[#${changedInfo.num}] ${changedInfo.name}` : '无动爻');
      // mutual hex (from base)
      const mutualBools = [bools[1],bools[2],bools[3], bools[2],bools[3],bools[4]];
      const mutualInfo = hexInfoFromLines(mutualBools);
      renderHexagram(document.getElementById('lyMutualHex'), mutualBools);
      document.getElementById('lyMutualInfo').textContent = `[#${mutualInfo.num}] ${mutualInfo.name}`;

      const movingList = moving.map((m,i)=> m? (i+1):null).filter(Boolean); // bottom index
      const summary = `动爻：${movingList.length? movingList.join(', ') + '（自下而上序号）' : '无'}`;
      document.getElementById('lySummary').textContent = summary;

      // store last computed for saving
      window._lastLiuYao_ = {
        valsTopDown, order,
        base: baseInfo,
        changed: changedInfo,
        mutual: mutualInfo,
        moving: movingList
      };
    }

    function setupLiuYao(){
      const box = document.getElementById('lyInputs');
      const labels = ['上六(6)','五(5)','四(4)','三(3)','二(2)','初(1)'];
      box.innerHTML = '';
      for(let i=0;i<6;i++){
        const row = document.createElement('div');
        row.className = 'line-row';
        row.innerHTML = `<label>${labels[i]}</label>
          <select class="line-select ly-line-select">
            <option value="7">7 少阳(—)</option>
            <option value="8">8 少阴(--)</option>
            <option value="9">9 老阳(动)</option>
            <option value="6">6 老阴(动)</option>
          </select>`;
        box.appendChild(row);
      }
      document.getElementById('computeLiuyao').addEventListener('click', computeLiuYao);
      document.getElementById('saveLiuyao').addEventListener('click', ()=>{
        if(!window._lastLiuYao_) { toast('请先计算'); return; }
        addNote({
          type:'liuyao',
          base: `[#${window._lastLiuYao_.base.num}] ${window._lastLiuYao_.base.name}`,
          changed: (window._lastLiuYao_.moving.length? `[#${window._lastLiuYao_.changed.num}] ${window._lastLiuYao_.changed.name}`:'无'),
          mutual: `[#${window._lastLiuYao_.mutual.num}] ${window._lastLiuYao_.mutual.name}`,
          moving: window._lastLiuYao_.moving,
          ts: Date.now()
        });
        toast('已保存到笔记');
      });
    }

    // ---------- Theme ----------
    const THEME_KEY = 'oracle-theme';
    function loadTheme(){ return localStorage.getItem(THEME_KEY) || 'dark'; }
    function saveTheme(v){ localStorage.setItem(THEME_KEY, v); }
    function applyTheme(v){ document.documentElement.setAttribute('data-theme', v); }
    $('#toggleTheme').addEventListener('click', ()=>{
      const cur = loadTheme(); const nxt = cur==='dark' ? 'light' : 'dark';
      saveTheme(nxt); applyTheme(nxt);
    });

    // light theme tweaks via [data-theme]
    const style = document.createElement('style');
    style.textContent = `
      [data-theme="light"] { --bg:#f7f5f1; --bg-soft:#f4efe6; --panel:#fff; --ink:#1b1b1d; --ink-dim:#333; --muted:#6d6a63; --brand:#9a6d1e; --ring: rgba(154,109,30,.2); }
      [data-theme="light"] .hero-card, [data-theme="light"] .card { background: #fff; border-color:#ece7dc; }
      [data-theme="light"] .nav { background: linear-gradient(180deg, rgba(255,255,255,0.9), rgba(255,255,255,0.6)); border-bottom-color:#eee5d6; }
      [data-theme="light"] .nav-links a:hover { background:#f5efe3; }
      [data-theme="light"] .btn { background:#fff; border-color:#e9e2d4; }
      [data-theme="light"] .btn.primary { background: linear-gradient(180deg, #fffbf2, #f2eadc); border-color:#e7dcc6; color:#3a2e16; }
      [data-theme="light"] .branch { background:#fff7ed; border-color:#f2e6cf; }
    `;
    document.head.appendChild(style);

    // ---------- Toast ----------
    function toast(msg){
      const t = document.createElement('div');
      t.textContent = msg;
      t.style.cssText = `position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:#111; color:#eee; padding:10px 14px; border:1px solid #333; border-radius:999px; box-shadow:${getComputedStyle(document.documentElement).getPropertyValue('--shadow')}`;
      document.body.appendChild(t);
      setTimeout(()=>{ t.remove(); }, 1600);
    }

    // ---------- Init ----------
    (function init(){
      applyTheme(loadTheme());
      newShefuRound();
      renderNotes();
      $('#year').textContent = new Date().getFullYear();
      setupLiuYao();
    })();
  </script>
</body>
</html>
